// Code generated by `tools/entity-gen`. DO NOT EDIT.
package entity

import (
	"context"
	"database/sql"
	"time"

	"github.com/imantung/boilerplate-go-backend/internal/app/infra/di"
	"github.com/imantung/boilerplate-go-backend/pkg/repokit"
	"github.com/imantung/dbtxn"

	sq "github.com/Masterminds/squirrel"
)

var (
	Oauth2ClientTableName = "oauth2_clients"
	Oauth2ClientColumns   = struct {
		ID        string
		Secret    string
		Domain    string
		DeletedAt string
		UpdatedAt string
		CreatedAt string
	}{
		ID:        "id",
		Secret:    "secret",
		Domain:    "domain",
		DeletedAt: "deleted_at",
		UpdatedAt: "updated_at",
		CreatedAt: "created_at",
	}
)

type (
	Oauth2Client struct {
		ID        string     `column:"id"`
		Secret    string     `column:"secret"`
		Domain    string     `column:"domain"`
		DeletedAt *time.Time `column:"deleted_at"`
		UpdatedAt time.Time  `column:"updated_at"`
		CreatedAt time.Time  `column:"created_at"`
	}
	Oauth2ClientRepo interface {
		Count(context.Context, ...repokit.SelectOption) (int64, error)
		Select(context.Context, ...repokit.SelectOption) ([]*Oauth2Client, error)
		Insert(context.Context, *Oauth2Client) (string, error)
		SoftDelete(context.Context, string) (int64, error)
		Update(context.Context, *Oauth2Client, ...repokit.UpdateOption) (int64, error)
		Patch(context.Context, *Oauth2Client, ...repokit.UpdateOption) (int64, error)
	}
	Oauth2ClientRepoImpl struct {
		*sql.DB
	}
)

var _ = di.Provide(NewOauth2ClientRepo)

func NewOauth2ClientRepo(db *sql.DB) Oauth2ClientRepo {
	return &Oauth2ClientRepoImpl{
		DB: db,
	}
}

func (r *Oauth2ClientRepoImpl) Count(ctx context.Context, opts ...repokit.SelectOption) (int64, error) {
	txn, err := dbtxn.Use(ctx, r.DB)
	if err != nil {
		return -1, err
	}
	builder := sq.
		Select("count(1)").
		From("oauth2_clients").
		Where(sq.Eq{"deleted_at": nil}).
		RunWith(txn)

	for _, opt := range opts {
		builder = opt.CompileSelect(builder)
	}

	row := builder.QueryRowContext(ctx)

	var cnt int64
	if err := row.Scan(&cnt); err != nil {
		return -1, err
	}
	return cnt, nil
}

func (r *Oauth2ClientRepoImpl) Select(ctx context.Context, opts ...repokit.SelectOption) ([]*Oauth2Client, error) {
	txn, err := dbtxn.Use(ctx, r.DB)
	if err != nil {
		return nil, err
	}
	builder := sq.
		Select(
			"id",
			"secret",
			"domain",
			"deleted_at",
			"updated_at",
			"created_at",
		).
		From("oauth2_clients").
		Where(sq.Eq{"deleted_at": nil}).
		PlaceholderFormat(sq.Dollar).
		RunWith(txn)

	for _, opt := range opts {
		builder = opt.CompileSelect(builder)
	}

	rows, err := builder.QueryContext(ctx)
	if err != nil {
		return nil, err
	}

	list := make([]*Oauth2Client, 0)
	for rows.Next() {
		ent := new(Oauth2Client)
		err := rows.Scan(
			&ent.ID,
			&ent.Secret,
			&ent.Domain,
			&ent.DeletedAt,
			&ent.UpdatedAt,
			&ent.CreatedAt,
		)
		if err != nil {
			return nil, err
		}
		list = append(list, ent)
	}
	return list, nil
}

func (r *Oauth2ClientRepoImpl) Insert(ctx context.Context, ent *Oauth2Client) (string, error) {
	txn, err := dbtxn.Use(ctx, r.DB)
	if err != nil {
		return "", err
	}

	builder := sq.
		Insert("oauth2_clients").
		Columns(
			"secret",
			"domain",
		).
		Suffix(
			"RETURNING id",
		).
		PlaceholderFormat(sq.Dollar).
		Values(
			ent.Secret,
			ent.Domain,
		)

	scanner := builder.RunWith(txn).QueryRowContext(ctx)

	var id string
	if err := scanner.Scan(&id); err != nil {
		txn.AppendError(err)
		return "", err
	}
	return id, nil
}

func (r *Oauth2ClientRepoImpl) Update(ctx context.Context, ent *Oauth2Client, opts ...repokit.UpdateOption) (int64, error) {
	txn, err := dbtxn.Use(ctx, r.DB)
	if err != nil {
		return -1, err
	}

	builder := sq.
		Update("oauth2_clients").
		Set("secret", ent.Secret).
		Set("domain", ent.Domain).
		Set("updated_at", "now()").
		PlaceholderFormat(sq.Dollar).
		RunWith(txn)

	for _, opt := range opts {
		builder = opt.CompileUpdate(builder)
	}

	res, err := builder.ExecContext(ctx)
	if err != nil {
		txn.AppendError(err)
		return -1, err
	}
	affectedRow, err := res.RowsAffected()
	txn.AppendError(err)
	return affectedRow, err
}

func (r *Oauth2ClientRepoImpl) Patch(ctx context.Context, ent *Oauth2Client, opts ...repokit.UpdateOption) (int64, error) {
	txn, err := dbtxn.Use(ctx, r.DB)
	if err != nil {
		return -1, err
	}

	builder := sq.
		Update("oauth2_clients").
		PlaceholderFormat(sq.Dollar).
		RunWith(txn)

	if !repokit.IsZero(ent.Secret) {
		builder = builder.Set("secret", ent.Secret)
	}
	if !repokit.IsZero(ent.Domain) {
		builder = builder.Set("domain", ent.Domain)
	}

	builder = builder.Set("updated_at", "now()")

	for _, opt := range opts {
		builder = opt.CompileUpdate(builder)
	}

	res, err := builder.ExecContext(ctx)
	if err != nil {
		txn.AppendError(err)
		return -1, err
	}

	affectedRow, err := res.RowsAffected()
	txn.AppendError(err)
	return affectedRow, err
}

func (r *Oauth2ClientRepoImpl) SoftDelete(ctx context.Context, id string) (int64, error) {
	txn, err := dbtxn.Use(ctx, r.DB)
	if err != nil {
		return -1, err
	}

	builder := sq.
		Update("oauth2_clients").
		Set("deleted_at", "now()").
		Where(sq.Eq{"id": id}).
		PlaceholderFormat(sq.Dollar).
		RunWith(txn)

	res, err := builder.ExecContext(ctx)
	if err != nil {
		txn.AppendError(err)
		return -1, err
	}
	affectedRow, err := res.RowsAffected()
	txn.AppendError(err)

	return affectedRow, nil
}
